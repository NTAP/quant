#! /usr/bin/env bash

function make_name() {
        local path filename extension
        path=$(dirname "$1")
        filename=$(basename "$1")
        extension="${filename##*.}"
        filename="${filename%.*}"
        if [[ -e $path/$filename.$extension ]] ; then
            i=1
            while [[ -e $path/$filename-$i.$extension ]] ; do
                let i++
            done
            filename=$filename-$i
        fi
        echo "$path/$filename.$extension"
}

function cid_make_name() {
        local path cid
        path=$(dirname "$1")
        cid=$(grep -o 'cid=[^ ]*' "$1" | cut -f2 -d= | head -n1)
        echo "$path/$cid.html"
}

export PATH="$PATH:~/bin"

name=/var/www/html/log.html
new=$(cid_make_name $name)
mv "$name" "$new"
mail -s "$new" lars@netapp.com -A "$new" < /dev/null

cat <<-EOF > /var/www/html/.htaccess
RewriteRule ^log$ /$(basename "$new") [R]
EOF

mkdir -p @CMAKE_BINARY_DIR@
cd @CMAKE_BINARY_DIR@ || exit
git pull
cmake -GNinja ..
ninja
sudo setcap 'cap_net_bind_service=+ep' bin/server
bin/server -v4 -i eth0 -p 443 -p 4433 \
    -d /usr/share/apache2/default-site \
    -c /etc/letsencrypt/live/quant.eggert.org/fullchain.pem \
    -k /etc/letsencrypt/live/quant.eggert.org/privkey.pem \
    2>&1 | aha -s > "$name"
